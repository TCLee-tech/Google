## Introduction to [Docker](docker.com)
  
Open-source platform for developing, shipping and running applications in containers.  
Containers are sandboxed processes isolated from all other processes on host machine.  
[Demystifying Containers - Part I: Kernel Space](https://medium.com/@saschagrunert/demystifying-containers-part-i-kernel-space-2c53d6979504)  

### Run  
- To run a container, `docker run [imageName]`
    - docker daemon will search locally for image
    - if image is not found, it will try to pull from public registry Docker Hub
    - if pull successful, it will create container
    - then run container
    - container Names are randomly generated by Dockers. To specify container name, `docker run --name [containerName] [imageName]`

- To list all Docker images, `docker images`
    - image ID is in [SHA256 hash](https://www.movable-type.co.uk/scripts/sha256.html) format

- To list containers: `docker ps` 
  - default lists running containers.
  - to list all containers, including those already exited and no longer running: `docker ps -a`
  - [`docker ps [OPTIONS]` reference](https://docs.docker.com/engine/reference/commandline/ps/)

    
### Build
- to build a Docker image, need a Dockerfile and an application.  

1. create a Dockerfile.  
A Dockerfile is a text document containing all the commands a user will call on a command line to assemble an image.  
[Dockerfile reference](https://docs.docker.com/engine/reference/builder/)  

```
cat > Dockerfile <<EOF
FROM node:lts           //specifies base parent image. Example here is Docker Official Image for node.js. 
WORKDIR /app            //set working (current) directory of container
ADD . /app              //add current directory's contents (".") into container's /app folder
EXPOSE 80               //expose container's port 80 to accept connections
CMD ["node", "app.js"]  //run app.js using node when container launches
EOF                     //end of file
```
[Docker Hub images](https://hub.docker.com/search?image_filter=official&q=&page=2)

Aside:
  - **EOF** is a "Here tag".
  - `<<EOF` tells shell you are entering a multi-line string from the next line onwards, until the `Here` "tag".
  - `Here` can be any string, but it is often **EOF** or **STOP**.
  - EOF - End of File
  - Rules:
    - tag can be any string, uppercase (convention) or lowercase
    - tag must be by itself on a line
    - tag must have no leading or trailing space/s.
  - the multi-line string is a [Here document](https://en.wikipedia.org/wiki/Here_document#Unix_shells)
    - it is a file literal
    - text is passed as input to command, shell variable, file or pipe
    - variable names are replaced by values (e.g. "$PWD" becomes "/home/user") and backticks are evaluated (e.g. \`pwd` becomes /home/user)
  - `<<` is the **redirect** identifier
    - points towards command that "Here document" is provided as input
  - `cat > [filename]` is command to direct input to a file. 
    - will create new file if it does not exist, or over-write existing file.
    - `cat >> [filename]` will **append** "Here document" to end of existing file, without modifying existing content.
    - `cat` alone will display input in Unix shell terminal

2. create a node.js application  
This example is a HTTP server that listens on port 80 and returns "Hello World" in plain text 
```
cat > app.js <<EOF
const http = require('http');
const hostname = '0.0.0.0';
const port = 80;

const server = http.createServer((req, res) => {            //http.createServer() method. request, response
    res.statusCode = 200;
    res.setHeader('Content-Type', 'text/plain');
    res.end('Hello World\n')                                // \n for line break
    });

server.listen(port, hostname, () => {
    console.log('Server running at http://%s:%s/', hostname, port);
    });

process.on('SIGINT', function() {
    console.log('Caught interrupt signal and will exit');
    process.exit();
    });
EOF
```

3. `docker build -t node-app:0.1 .`  
    - must run `docker build` from directory that **has Dockerfile**. "." means the current directory.   
    - `-t` is to tag image with [name:tag] syntax. 
    - tag recommended for versioning. 
    - If not specified, tag will default to "latest". 
    - it is hard to distinguish new and old images without tagging.

4. List all Docker images  
    - `docker images`
    - to verify build
    - will see `node` base image and newly built `node-app` image
    - cannot remove base image without removing images built on it
    - [Docker Official Image for node](https://hub.docker.com/_/node)
    - node Image variants `node:<version>-alpine` and `node:<version>-slim` are even smaller in sizes, more portable

### Run
`docker run -p 4000:80 --name my-app -d node-app:0.1` 
  - `-p` flag maps host's port 4000 to container's port 80. 
  - `--name` flag is to name the container "my-app".
  - `-d` flag is to run container in "detached" mode. Container will continue running in background after terminal's session closed. Without `-d`, container will terminate when terminal closed.

`docker stop [container name or id]`  
  - stop container

`docker rm [container name]` 
  - remove container 
  - `docker rm $(docker ps -aq)` to remove all containers
    - `-a` tag to show all containers
    - `-q` tag to only display container IDs
  - use `docker images` to verify

`docker rmi [image-id]:[tag] [hostname, e.g. gcr.io]/[repo name]/[image-id]:[tag]`
  - remove images from host node. 
  - must remove child image before can remove base image.
  - [docker rmi](https://docs.docker.com/engine/reference/commandline/rmi/)

Trouble shooting
  - `docker logs -f [container-id]`  
    - to look at the logs. 
    - `-f` flag displays real-time logs when container is running

  - `docker exec -it [container-id] bash`
    - to run command in running container
      - a container is running when its primary process (PID 1) is running
      - command fails when container paused
    - `-it`: the `-i` keeps stdin open even if not attached; the `-t` allocates a pseudo-tty.
    - `bash` will start a bash session in the container
    - Bash runs in WORKDIR (working directory) specified in the Dockerfile.
    - remember to `exit` bash session.
    - [`docker exec` reference](https://docs.docker.com/engine/reference/commandline/exec/)

  - `docker inspect [container-id]`
    - to look at metadata of container. 
    - return in JSON format
    - `--format` to inspect specific field
      - e.g. `docker inspect --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' [container_id]`
    - [docker inspect reference](https://docs.docker.com/engine/reference/commandline/inspect/)

### Publish
An example of a container registry is the [Google Container Registry](https://cloud.google.com/container-registry/)  
To push a local image to a registry, you need to **tag** the image with the registry name.  
  - tag is in the format `[hostname, e.g. gcr.io]/[repo or project-id]/[image-name]: [tag]`
  - `docker tag [image-name]:[tag] [hostname, e.g. gcr.io]/[repo or project-id]/[image-name]:[tag]`
  - use `docker images` to verify    

To push to registry, `docker push [hostname][repo or project-id]/[image-name]:[tag]`  
    - to verify, visit registry webpage  

To pull image from registry, `docker pull [hostname][repo or project-id]/[image-name]:[tag]`
  - then `docker run -p 8080:80 -d [...full image tagged name]`
